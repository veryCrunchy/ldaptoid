# Data Model: LDAP Read-only Proxy

Status: DRAFT
Generated: 2025-09-16

## Conventions
- TypeScript types / interfaces (Deno)
- All IDs immutable after assignment
- Timestamps in ISO 8601 UTC

## Entities

### User
| Field | Type | Source | Notes |
|-------|------|--------|-------|
| id | string | IdP | Stable IdP GUID / key |
| username | string | IdP | Maps to `uid` attribute |
| displayName | string | IdP | Maps to `cn` / `gecos` |
| email | string | IdP | Optional; may populate `mail` |
| active | boolean | Derived | From IdP status fields |
| posixUid | number | Derived | Deterministic allocator |
| primaryGroupId | string | Derived | SyntheticPrimaryGroup.id |
| memberGroupIds | string[] | IdP | Direct group memberships |
| createdAt | string | IdP | Auditing only |
| updatedAt | string | IdP | Auditing only |

### Group
| Field | Type | Source | Notes |
|-------|------|--------|-------|
| id | string | IdP | Stable IdP GUID |
| name | string | IdP | Maps to `cn` |
| description | string | IdP | Optional |
| memberUserIds | string[] | IdP | Direct user members |
| memberGroupIds | string[] | IdP | Nested groups if supported |
| posixGid | number | Derived | Deterministic allocator |
| isSynthetic | boolean | Derived | False for native IdP groups |

### SyntheticPrimaryGroup
| Field | Type | Source | Notes |
|-------|------|--------|-------|
| id | string | Derived | e.g., `spg:{user.id}` |
| gidNumber | number | Derived | Separate deterministic range or same as user UID |
| userId | string | Derived | Owning user |

### MirroredGroup
| Field | Type | Source | Notes |
|-------|------|--------|-------|
| id | string | Derived | e.g., `mirror:{targetGroupId}` |
| targetGroupId | string | Derived | Source group id |
| posixGid | number | Derived | From target or new allocation |

### Snapshot
| Field | Type | Source | Notes |
|-------|------|--------|-------|
| users | User[] | Aggregate | Filtered for active only |
| groups | Group[] | Aggregate | Includes synthetic/mirrored |
| generatedAt | string | System | Snapshot build timestamp |
| sequence | number | System | Monotonic counter |
| featureFlags | string[] | Config | Enabled features at build |

### FeatureFlags
| Field | Type | Source | Notes |
|-------|------|--------|-------|
| name | string | Config | Identifier |
| enabled | boolean | Config | State |
| description | string | Config | Purpose |

### BackendAdaptor (Interface)
| Method | Input | Output | Notes |
|--------|-------|--------|-------|
| fetchUsers() | cursor/params | RawUser[] | Must include active state source fields |
| fetchGroups() | cursor/params | RawGroup[] | May need pagination |
| fetchGroupMemberships() | group ids | Map<groupId,userIds> | Optional separate call |
| health() | - | { ok: boolean; details?: any } | For readiness |

### RawUser / RawGroup (IdP-Specific)
Represent opaque records from IdPs; mapped by adaptor mappers into canonical entities.

## Relationships
- User (1) — (1) SyntheticPrimaryGroup
- Group (recursive) via memberGroupIds (acyclic enforced or truncated)
- User (many) — (many) Group (through membership)

## Derived Data Rules
1. posixUid / posixGid assigned via deterministic hash(user.id|group.id) with collision map.
2. Synthetic primary group enabled only if feature flag `synthetic_primary_group` true.
3. Mirrored groups created for nested groups if feature flag `mirror_nested_groups` true.
4. Inactive users excluded from snapshot; memberships referencing them removed.
5. memberOf overlay generated by reverse indexing group memberships.

## Validation Rules
- Username must be LDAP-compatible (sanitize illegal chars: replace spaces with `_`).
- Group name uniqueness: collisions resolved by suffix `_n` deterministic stable.
- UID/GID ranges: reserve <1000 for system; start allocations at 1000.
- Collision: if hash result collides, append `:1`, re-hash, repeat (max 5) then fallback incremental.

## Open Questions
- Final hash algorithm & salt scheme (see research #3, #10).
- gidNumber for SyntheticPrimaryGroup = user UID? (Simplifies mapping) TBD.
- Maximum group nesting depth allowed (protection vs expansion). TBD (candidate: 5).

## Mapping to LDAP Attributes (Initial Subset)
| LDAP Attr | Source Field | Notes |
|-----------|--------------|-------|
| uid | User.username | |
| cn | User.displayName or Group.name | |
| mail | User.email | Omit if empty |
| memberOf | Derived overlay | Multi-valued |
| gidNumber | Group.posixGid / SyntheticPrimaryGroup.gidNumber | |
| uidNumber | User.posixUid | |
| objectClass | static list | Depends on entry type |

## Future Extensions
- Delta snapshots (incremental updates)
- Attribute filtering per client
- StartTLS support
